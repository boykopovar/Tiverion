@model Tiverion.Models.ViewModels.Settings.SettingsViewModel
@using System.ComponentModel.DataAnnotations
@using Tiverion.Data.Constants
@using Tiverion.Models.Entities.Enums
@using Tiverion.Models.Platform
@{
    Layout = "_Layout";
    ViewData["Title"] = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏";
    var activeCount = Model.Invitations?.Count(i => !i.ActivatedAt.HasValue) ?? 0;
    var roleEmojis = new Dictionary<UserRole, string>
    {
        { UserRole.Visitor, "üë§" },
        { UserRole.Tester, "üß™" },
        { UserRole.User, "üßë‚Äç" },
        { UserRole.Admin, "üëë" }
    };
    
    var titleMax = typeof(Invitation)
        .GetProperty(nameof(Invitation.Title))
        ?.GetCustomAttributes(typeof(MaxLengthAttribute), false)
        .Cast<MaxLengthAttribute>()
        .FirstOrDefault()?.Length ?? 0;

    var messageMax = typeof(Invitation)
        .GetProperty(nameof(Invitation.Message))
        ?.GetCustomAttributes(typeof(MaxLengthAttribute), false)
        .Cast<MaxLengthAttribute>()
        .FirstOrDefault()?.Length ?? 0;
}
<partial name="_TopNav" />

<section class="tokens">
    <div class="tokens-inner">
        <h1 class="title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è–º–∏</h1>
        <p class="subtitle">–°–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-error">@TempData["Error"]</div>
        }
        else if (TempData["Success"] != null)
        {
            <div class="alert alert-success">@TempData["Success"]</div>
        }

        <div class="tokens-controls" style="flex-direction:column; align-items:stretch; gap:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div style="font-weight:700; color:#07263f; font-size:16px; text-align:left;">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö: @activeCount</div>
                <div style="color:#3b5570; font-size:13px; text-align:right;">–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π: @(Model.Invitations?.Count ?? 0)</div>
            </div>

            <div style="margin:8px 0;">
                <label style="display:flex; align-items:center; gap:6px; font-size:14px; color:#07263f;">
                    <input type="checkbox" id="filter-available" checked />
                    –¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
                </label>
            </div>

            <div class="responsive-table" style="width:100%;">
                <table id="invitation-table">
                    <thead>
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                        <th>–†–æ–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–æ–∑–¥–∞–Ω–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                    </thead>
                    <tbody>
                    @if (Model.Invitations?.Any() == true)
                    {
                        foreach (var inv in Model.Invitations.OrderByDescending(i => i.CreatedAt))
                        {
                            <tr data-status="@(inv.ActivatedAt.HasValue ? "activated" : "available")">
                                <td>@inv.Title</td>
                                <td>@(string.IsNullOrWhiteSpace(inv.Message) ? "-" : inv.Message)</td>
                                <td>@inv.Role</td>
                                <td>@(inv.ActivatedAt.HasValue ? "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ" : "–î–æ—Å—Ç—É–ø–Ω–æ")</td>
                                <td>@inv.CreatedAt.ToString("yyyy-MM-dd")</td>
                                <td>
                                    <button class="btn outline copy-link" data-id="@inv.Id" type="button">üìã</button>
                                    <form method="post" asp-action="DeleteInvitation" class="inline-form" style="display:inline-block; margin-left:8px;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@inv.Id"/>
                                        <button class="btn outline" type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?');" style="color:#c62828;">–£–¥–∞–ª–∏—Ç—å</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="empty-table">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>

            <div style="width:100%;">
                <h3 style="margin-top:0; margin-bottom:8px;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</h3>
                <form method="post" asp-action="CreateInvitation" class="add-invite-form" style="width:100%;">
                    @Html.AntiForgeryToken()
                    <div class="form-row" style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap;">
                        <input type="text" name="title" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" maxlength="@titleMax" required style="flex:1; min-width:220px;" />
                        <input type="text" name="message" class="form-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" maxlength="@messageMax" style="flex:1; min-width:220px;" />
                        <select name="role" class="form-select" style="width:160px;">
                            @foreach (UserRole role in Enum.GetValues(typeof(UserRole)))
                            {
                                <option value="@Convert.ToInt32(role)">@role</option>
                            }
                        </select>
                    </div>
                    <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                        <button type="button" id="create-reset" class="btn outline" style="width:140px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        <button type="submit" class="btn primary" style="width:220px;">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>

        <h1 class="title" style="margin-top:36px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        <p class="subtitle">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã</p>

        <div class="users-grid" style="margin-top:12px;">
            @if (Model.Users?.Any() == true)
            {
                foreach (var user in Model.Users.OrderBy(u => u.Username))
                {
                    var emoji = roleEmojis.ContainsKey(user.Role) ? roleEmojis[user.Role] : "üë§";
                    <div class="card user-simple-card">
                        <div style="display:flex; gap:12px; align-items:center;">
                            <div class="role-avatar">@emoji</div>
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <h3 style="margin:0;">@user.Username</h3>
                                        <div style="font-size:13px; color:#3b5570;">@user.Role</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:13px; color:#3b5570;">@user.CreatedAt.ToString("yyyy-MM-dd")</div>
                                    </div>
                                </div>
                                <div style="margin-top:10px; display:flex; gap:8px;">
                                    <form method="post" asp-controller="Users" asp-action="Edit" class="inline-form">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@user.Id"/>
                                        <button class="btn outline" type="submit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    </form>
                                    <form method="post" asp-controller="Users" asp-action="Delete" class="inline-form" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@user.Id"/>
                                        <button class="btn outline" type="submit" style="color:#c62828;">–£–¥–∞–ª–∏—Ç—å</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="card">
                    <div class="empty-table">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>
                </div>
            }
        </div>
        <div style="margin-top:24px; display:flex; justify-content:flex-end;">
            <form method="post" asp-controller="Account" asp-action="Logout" onsubmit="return confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn outline" style="color:#c62828; border-color:#c62828; width:220px; padding:8px 20px;">
                    –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                </button>
            </form>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.querySelectorAll('.copy-link').forEach(btn => {
            btn.addEventListener('click', function() {
                var id = this.getAttribute('data-id');
                var url = location.origin + '@PlatformSettings.Urls.RegisterPage?invitationId=' + encodeURIComponent(id);
                navigator.clipboard.writeText(url).then(() => {
                    var prev = this.textContent;
                    this.textContent = '‚úÖ';
                    setTimeout(() => this.textContent = prev, 1500);
                });
            });
        });

        const filterCheckbox = document.getElementById('filter-available');
        const rows = document.querySelectorAll('#invitation-table tbody tr[data-status]');

        function applyFilter() {
            const onlyAvailable = filterCheckbox.checked;
            rows.forEach(row => {
                if (onlyAvailable && row.dataset.status === 'activated') {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });
        }

        filterCheckbox.addEventListener('change', applyFilter);
        applyFilter();

        var createReset = document.getElementById('create-reset');
        if (createReset) {
            createReset.addEventListener('click', function () {
                var form = this.closest('form');
                if (!form) return;
                Array.from(form.querySelectorAll('input, select, textarea')).forEach(function (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = false;
                    } else {
                        el.value = '';
                    }
                });
            });
        }
    </script>
}
