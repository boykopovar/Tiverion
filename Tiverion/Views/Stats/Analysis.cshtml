@using System.Reflection
@using System.ComponentModel.DataAnnotations
@using Tiverion.Models.Entities.Enums
@using Tiverion.Models.ViewModels.Stats
@model Tiverion.Models.ViewModels.Stats.AnalysisRangeDto

@{
    Layout = "_Layout";
    ViewData["Title"] = "Анализ";

    string GetPeriodDisplayName(TimePeriod period, int count)
    {
        var attribute = period.GetAttribute<CountForm>();
        if (attribute is null) return period.GetDisplayName();

        return ((CountForm)attribute).GetWordForm(count);
    }
}

<section class="dashboard">
    <partial name="_TopNav" />
    <div class="dashboard-inner">

        <h1 class="title">Анализ</h1>
        <p class="subtitle">Расчет вероятности наступления погодных условий за определенный период.</p>

        <partial name="_ShowTempData"/>

        @if (Model.ResultPercent.HasValue && Model.Input != null)
        {
            var k = Model.Input?.AmountSuccess / (int)(Model.Input!.Period) ?? 0;
            var n = Model.Input?.NumberOfTrials / (int)(Model.Input!.Period) ?? 0;
            
        <div class="card" style="margin:16px 0; padding:18px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="font-weight:800; font-size:32px; color:var(--color-card-highlight);">
                    @Model.ResultPercent.Value.ToString("F3") %
                </div>
                <div style="color:var(--color-card-subtext); font-size:14px;">
                    Выполнение условий <strong>@k @GetPeriodDisplayName(Model.Input!.Period, k)</strong> из <strong>@n</strong> с шансом 
                    <strong>@Model.Percent.ToString("F3")%</strong>
                    @(Model.ByAverage ? $" (по средним значениям за {Model.SpanForAverageHours}ч)" : "")
                </div>
            </div>

            <div style="color:var(--color-card-subtext); font-size:13px;">
                Обработано записей: —
            </div>
        </div>
        }

        <form asp-action="Analysis" method="post" class="auth-panel" style="width:100%; max-width:1200px; box-sizing:border-box; padding:20px; display:block;" onsubmit="return convertToHours()">
            @Html.AntiForgeryToken()

            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px;">
                <div style="flex:1 1 200px;">
                    <label style="display:block; margin-bottom:6px;">Кол-во совпадений</label>
                    <input type="number" id="amountSuccessUnit" step="1"
                           placeholder="k" class="form-input" style="width:100%;" value="@(Model.Input?.AmountSuccess / (int)(Model.Input?.Period ?? TimePeriod.Day))"/>
                </div>

                <div style="flex:1 1 200px;">
                    <label style="display:block; margin-bottom:6px;">Количество испытаний</label>
                    <input type="number" id="numberOfTrialsUnit" step="1"
                           placeholder="n" class="form-input" style="width:100%;" value="@(Model.Input?.NumberOfTrials / (int)(Model.Input?.Period ?? TimePeriod.Day))"/>
                </div>

                <div style="flex:1 1 200px;">
                    <label style="display:block; margin-bottom:6px;">Единица измерения</label>
                    <select id="periodDropdown" name="Input.Period" class="form-select" style="width:100%;">
                        @{
                        foreach (TimePeriod period in Enum.GetValues(typeof(TimePeriod)))
                        {
                        var member = typeof(TimePeriod).GetMember(period.ToString()).First();
                        var displayName = member.GetCustomAttribute<DisplayAttribute>()?.Name ?? period.ToString();
                        var intValue = (int)period;
                        var selected = Model.Input?.Period == period;

                        if (Model.Input?.Period is null && intValue == 24) selected = true;
                        <option value="@intValue" selected="@(selected)">@displayName</option>
                        }
                        }
                    </select>
                </div>
            </div>

            @{
                var filters = new WeatherFiltersViewModel()
                {
                    Input = Model.Input,
                    ByAverage = Model.ByAverage,
                    SpanForAverageHours = Model.SpanForAverageHours
                };
            }
            <partial name="_WeatherFilters" model = "filters"/>
            
            <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:16px;">
                <a class="btn outline" href="@Url.Action("Analysis", "Stats")">Сброс</a>
                <button type="submit" class="btn primary">Вычислить вероятность</button>
            </div>
        </form>
    </div>
</section>

