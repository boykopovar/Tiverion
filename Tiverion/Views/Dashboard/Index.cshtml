@using System.Globalization
@using System.Linq
@using Tiverion.Data.Constants
@using Tiverion.Models.Entities.Enums
@using Tiverion.Models.Entities.ServiceEntities.Weather
@using Tiverion.Models.ViewModels
@model Tiverion.Models.ViewModels.Dashboard.DashboardViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "–ü–∞–Ω–µ–ª—å";

    var activeTasks = Model.Tasks.Where(t => t.IsEnabled).ToList();
    var activeTasksCount = activeTasks.Count;

    var errorEntries = Model.LastDayResults.SelectMany(r => r.Errors ?? Enumerable.Empty<string>()).ToList();
    var totalErrors = errorEntries.Count;
    var sampleErrors = errorEntries.Take(3).Select(s => s.Length > 220 ? s.Substring(0, 220) + "‚Ä¶" : s).ToList();

    double callsPerDay = Model.Tasks.Sum(t => t.Interval.TotalSeconds > 0 ? Math.Floor(86400.0 / t.Interval.TotalSeconds) : 0);
    var callsPerHour = callsPerDay / 24.0;

    var lastTaskResult = Model.LastDayResults.OrderByDescending(r => r.TaskStartTime).FirstOrDefault();
    var lastWeather = lastTaskResult is null ? null : Model.LastDayWeatherStamps
        .OrderByDescending(w => w.Timestamp)
        .FirstOrDefault(w => w.TaskId == lastTaskResult.TaskId);
    var lastTask = lastTaskResult is null ? null : Model.Tasks.FirstOrDefault(t => t.Id == lastTaskResult.TaskId);
    
    
    string FormatNumber(double v) => v.ToString("N0", CultureInfo.GetCultureInfo("ru-RU"));
    string FormatSmall(double v) => v.ToString("N1", CultureInfo.GetCultureInfo("ru-RU"));
}

<section class="dashboard">
    <partial name="_TopNav" />

    <div class="dashboard-inner">
        <h1 class="title">–ü–∞–Ω–µ–ª—å</h1>
        <p class="subtitle">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π.</p>

        <partial name="_ShowTempData"/>

        <div class="card-grid">
            <div class="card">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h3>
                <div style="display:flex;align-items:center;gap:12px;flex-grow:1;">
                    <div style="font-size:28px;font-weight:700;">@activeTasksCount</div>
                    <div style="color:var(--color-card-subtext)">
                        <div style="font-weight:600;margin-bottom:6px;">
                            @if(activeTasksCount>0) { <text>@string.Join(", ", activeTasks.Take(4).Select(t => t.Name))@((activeTasksCount>4) ? "‚Ä¶" : "")</text> }
                            else { <text>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö</text> }
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>–û—à–∏–±–∫–∏ –∑–∞ 24—á</h3>
                <div style="display:flex;align-items:center;gap:12px;flex-grow:1;">
                    <div style="font-size:28px;font-weight:700;color:@(totalErrors>0 ? "var(--color-alert-error-text)" : "var(--color-alert-success-text)")">@totalErrors</div>
                    <div style="color:var(--color-card-subtext)">
                        <div style="font-weight:600;margin-bottom:6px;">
                            @if(totalErrors==0) { <text>–ü—Ä–æ–±–ª–µ–º –Ω–µ—Ç</text> }
                            else if(totalErrors==1) { <text>1 –∑–∞–ø–∏—Å—å —Å –æ—à–∏–±–∫–æ–π</text> }
                            else { <text>@totalErrors –∑–∞–ø–∏—Å–µ–π —Å –æ—à–∏–±–∫–∞–º–∏</text> }
                        </div>
                        @if(sampleErrors.Any())
                        {
                            <div style="max-height:72px;overflow:auto;font-size:12px;background:#fff;padding:6px;border-radius:6px;border:1px solid rgba(198,40,40,0.06);">
                                @foreach(var e in sampleErrors) { <div style="margin-bottom:6px;">@e</div> }
                                @if(errorEntries.Count > sampleErrors.Count) { <div>‚Ä¶</div> }
                            </div>
                        }
                        else { <div style="font-size:13px;">–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div> }
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>–¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞</h3>
                <div style="display:flex;align-items:center;gap:12px;flex-grow:1;">
                    <div style="font-size:28px;font-weight:700;">@FormatNumber(callsPerDay)</div>
                    <div style="color:var(--color-card-subtext)">
                        <div style="font-weight:600;margin-bottom:6px;">–û—Ü–µ–Ω–∫–∞ –≤—ã–∑–æ–≤–æ–≤ –≤ –¥–µ–Ω—å</div>
                        <div style="font-size:13px;">~ @FormatSmall(callsPerHour) –∑–∞–¥–∞—á –≤ —á–∞—Å</div>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="card" style = "margin-bottom: 16px; margin-top: 16px">
            <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–¥–∞—á–∞</h3>

            @if(lastTaskResult is null)
            {
                <div style="font-weight:600">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á —Å–µ–≥–æ–¥–Ω—è</div>
            }
            else
            {
                
                var diff = DateTime.UtcNow - lastTaskResult.TaskEndTime;
                string diffText = diff.TotalMinutes < 1 ? "<1 –º–∏–Ω" :
                    diff.TotalMinutes < 60 ? $"{Math.Round(diff.TotalMinutes)} –º–∏–Ω" :
                    diff.TotalHours < 24 ? $"{Math.Round(diff.TotalHours)} —á" :
                    diff.TotalDays < 7 ? $"{Math.Round(diff.TotalDays)} –¥" :
                    diff.TotalDays < 30 ? $"{Math.Round(diff.TotalDays / 7)} –Ω–µ–¥" :
                    diff.TotalDays < 365 ? $"{Math.Round(diff.TotalDays / 30)} –º–µ—Å" :
                    $"{Math.Round(diff.TotalDays / 365)} –≥";

                <div style="font-weight:700;font-size:16px; margin-bottom:4px;">
                    @(lastTask is null ? "–ü–∞–Ω–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞" : lastTask.Name)
                </div>

                <div style="display:flex; gap:12px; font-size:13px; color:var(--color-card-subtext);">
                    <div>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: @diffText –Ω–∞–∑–∞–¥</div>
                </div>

                @if (lastWeather != null)
                {
                    <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; align-items:stretch;">
                        <div style="background:var(--color-token-card-bg);padding:8px 12px;border-radius:8px;flex:1 1 200px;display:flex;gap:12px;align-items:center;">
                            <div style="display:flex;flex-direction:column;align-items:center;min-width:60px;">
                                <div style="font-size:28px;">
                                    @{
                                        var emoji = lastWeather.Condition switch
                                        {
                                            Condition.Clear => "‚òÄÔ∏è",
                                            Condition.PartlyCloudy => "üå§Ô∏è",
                                            Condition.Cloudy => "üå•Ô∏è",
                                            Condition.Overcast => "‚òÅÔ∏è",
                                            Condition.LightRain => "üå¶Ô∏è",
                                            Condition.Rain => "üåßÔ∏è",
                                            Condition.HeavyRain => "‚õàÔ∏è",
                                            Condition.LightSnow => "üå®Ô∏è",
                                            Condition.Snow => "‚ùÑÔ∏è",
                                            Condition.Sleet => "üå®Ô∏è",
                                            Condition.Thunderstorm => "‚õàÔ∏è",
                                            Condition.ThunderstormWithRain => "üå©Ô∏è",
                                            _ => "üå°Ô∏è"
                                        };
                                        string displayName = lastWeather.Condition.GetDisplayName();
                                    }
                                    @emoji
                                </div>
                                <div style="margin-top:4px;font-size:12px;color:var(--color-card-subtext);text-align:center;">
                                    @displayName
                                </div>
                            </div>

                            <div style="display:flex;flex-direction:column;flex-grow:1;gap:4px;">
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span>
                                    <span>@lastWeather.TemperatureCels¬∞C</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–û—â—É—â–∞–µ—Ç—Å—è</span>
                                    <span>@lastWeather.FeelsLikeCels¬∞C</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–í–ª–∞–∂–Ω–æ—Å—Ç—å</span>
                                    <span>@lastWeather.Humidity%</span>
                                </div>
                            </div>
                        </div>

                        <div style="background:var(--color-token-card-bg);padding:8px 12px;border-radius:8px;flex:1 1 200px;display:flex;gap:12px;align-items:center;">
                            <div style="display:flex;flex-direction:column;align-items:center;min-width:60px;">
                                <div style="font-size:28px;">üí®</div>
                                <div style="margin-top:4px;font-size:12px;color:var(--color-card-subtext);text-align:center;">
                                    –í–µ—Ç–µ—Ä
                                </div>
                            </div>

                            <div style="display:flex;flex-direction:column;flex-grow:1;gap:4px;">
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–°–∫–æ—Ä–æ—Å—Ç—å</span>
                                    <span>@lastWeather.WindSpeedMpS –º/—Å</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–ü–æ—Ä—ã–≤—ã</span>
                                    <span>@lastWeather.WindGustMpS –º/—Å</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–ù–∞–ø—Ä.</span>
                                    <span>@lastWeather.WindDirection.GetDisplayName()</span>
                                </div>
                            </div>
                        </div>

                        <div style="background:var(--color-token-card-bg);padding:8px 12px;border-radius:8px;flex:1 1 200px;display:flex;gap:12px;align-items:center;">
                            <div style="display:flex;flex-direction:column;align-items:center;min-width:60px;">
                                <div style="font-size:28px;">üå´Ô∏è</div>
                                <div style="margin-top:4px;font-size:12px;color:var(--color-card-subtext);text-align:center;">
                                    –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞
                                </div>
                            </div>

                            <div style="display:flex;flex-direction:column;flex-grow:1;gap:4px;">
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–î–∞–≤–ª–µ–Ω–∏–µ</span>
                                    <span>@lastWeather.PressureMmHg –º–º —Ä—Ç. —Å—Ç.</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–í–∏–¥–∏–º–æ—Å—Ç—å</span>
                                    <span>@lastWeather.VisibilityKm –º</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px;">
                                    <span>–û–±–ª–∞—á–Ω–æ—Å—Ç—å</span>
                                    <span>@lastWeather.Cloudiness.GetDisplayName()</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
        

        @{
            var mapModel = new MapViewModel(
                Model.LastPosition
            );
        }

        <form asp-action="Run" asp-controller="Dashboard" method="post" style="display:flex;flex-direction:column;gap:16px; margin-bottom: 30px">
            @Html.AntiForgeryToken()
            <partial name="_InteractiveMap" model="mapModel" />
            
            <div style="margin-bottom: 30px">
            </div>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px;">
                <button type="submit" class="btn primary full-width-btn">
                    –í—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
            </div>
        </form>

        @{
            var tableModel = new TasksTableViewModel(
                Model.Tasks,
                true
            );
        }
        @if (Model.Tasks.Count != 0)
        {
            <partial name="_TasksManageTable" model = "tableModel"/>
        }
    </div>

    
</section>
